import{u as C,c as g,r as f,A as p,_ as R}from"./index-MgNogqk5.js";import{I as E}from"./ui-vendor-Dw_Tg2Bf.js";import{d as N,o as M,r as d,y as _,k as w,l,A as y,D as L,H as P,x as U}from"./vue-vendor-BXjljxxF.js";import"./utils-CAMFpqwB.js";const $=N({name:"CallbackView",components:{Icon:E},setup(){const s=C(),e=d("Processing Authentication..."),o=d("Please wait while we complete your login"),k=d(!1),S=d(""),n=d(!1),t=d(!0),i=3,c=d(0),m=d(!1),h=d(!1),v="global_auth_callback_processing",A=()=>{window.location.href="/login"},I=()=>{const a=new URLSearchParams(window.location.search),r={url:window.location.href,hasCode:a.has("code"),code:a.has("code")?`${a.get("code")?.substring(0,5)}...`:null,hasState:a.has("state"),state:a.has("state")?a.get("state"):null,hasHash:!!window.location.hash,isLoggedIn:g.isLoggedIn()?"Yes":"No",storedState:sessionStorage.getItem("casdoor-state")||"None",retryCount:c.value,timestamp:new Date().toISOString(),userAgent:navigator.userAgent,callbackProcessed:h.value};return S.value=JSON.stringify(r,null,2),r},D=async()=>{const a=g.getToken();if(!a)return!1;try{return console.log("Found existing token - setting trust flags and SKIPPING validation completely"),localStorage.setItem("token_absolute_trust","true"),localStorage.setItem("token_trusted","true"),localStorage.setItem("token_verified","true"),localStorage.setItem("auth_callback_completed_time",Date.now().toString()),localStorage.setItem("skip_all_token_validation","true"),!0}catch(r){return console.error("Error setting trust flags:",r),!!a}},b=async()=>{try{if(await D()){e.value="Using existing session",o.value="Redirecting to dashboard...",t.value=!1,m.value=!1,h.value=!0,sessionStorage.setItem("auth_callback_processed","true"),window.location.href="/dashboard";return}const a=new URLSearchParams(window.location.search),r=a.get("code"),u=a.get("state");if((!r||!u)&&g.isLoggedIn()){console.log("No auth parameters but user is logged in, redirecting"),e.value="Already authenticated",o.value="Redirecting to dashboard...",t.value=!1,h.value=!0,sessionStorage.setItem("auth_callback_processed","true"),window.location.href="/dashboard";return}if(!r||!u){console.error("Missing authorization code or state in URL parameters"),e.value="Missing authorization parameters",o.value="Please try logging in again",t.value=!1,n.value=!0;return}if(g.getToken()){console.log("Token already exists in storage, validating...");try{if(await g.validateLocalToken()){console.log("Existing token is valid, using it"),e.value="Authentication already completed",o.value="Redirecting to dashboard...",t.value=!1,m.value=!1,h.value=!0,sessionStorage.setItem("auth_callback_processed","true"),sessionStorage.setItem("casdoor_processed_code",r),await s.refreshUserInfo(),setTimeout(()=>{window.location.href="/dashboard"},1e3);return}else console.log("Existing token is invalid, will get new token")}catch(T){console.error("Error validating existing token:",T)}}if(localStorage.getItem(v)==="true"){console.log("Global auth callback processing already in progress, skipping"),e.value="Authentication already in progress",o.value="Please wait for current process to complete",t.value=!1,n.value=!0;return}if(m.value||h.value){console.log("Skipping login process - already processed or processing");return}if(c.value>=i){e.value="Maximum retries reached",o.value="Please try one of the options below",t.value=!1,n.value=!0,k.value=!0;return}if(sessionStorage.getItem("processed_auth_code")===r)if(console.warn(`Authorization code ${r.substring(0,5)}... already processed, checking for tokens`),!g.getToken())console.log("No token found for processed code, clearing processed flag to retry"),sessionStorage.removeItem("processed_auth_code");else{e.value="This authorization code has already been used",o.value="Redirecting to dashboard...",t.value=!1,n.value=!1,setTimeout(()=>{window.location.href="/dashboard"},1500);return}m.value=!0,c.value++,t.value=!0,e.value="Completing authentication...",o.value=`Attempt ${c.value}/${i}`,n.value=!1,sessionStorage.setItem("auth_callback_in_progress","true"),localStorage.setItem(v,"true"),sessionStorage.setItem("processed_auth_code",r),console.log(`Processing authorization code: ${r.substring(0,5)}...`),c.value>1&&(console.log("Forcing token refresh on retry attempt"),sessionStorage.setItem("force_token_refresh","true"),sessionStorage.removeItem("casdoor-state"),sessionStorage.removeItem("casdoor-code-verifier"),sessionStorage.removeItem("casdoor-code-challenge"),sessionStorage.removeItem("casdoor_processed_code"),sessionStorage.removeItem("casdoor_auth_processed"));const x=await g.signinWithCode(r,u);if(console.log("Token obtained successfully:",!!x),!x)throw new Error("Failed to obtain authentication token");h.value=!0,sessionStorage.setItem("auth_callback_processed","true"),await s.refreshUserInfo(),e.value="Login successful!",o.value="Redirecting to dashboard...",t.value=!1,m.value=!1,localStorage.setItem("auth_callback_completed_time",Date.now().toString()),localStorage.setItem("token_verified","true"),localStorage.setItem("token_trusted","true"),localStorage.setItem("trust_flags_expire_at",(Date.now()+600*1e3).toString()),localStorage.removeItem(v),setTimeout(()=>{window.location.href="/dashboard"},1e3)}catch(a){if(console.error("Authentication error:",a),m.value=!1,localStorage.removeItem(v),c.value<i){e.value="Login attempt failed",o.value=`Will retry in ${c.value*2} seconds...`;const r=c.value*2e3;sessionStorage.removeItem("auth_callback_in_progress"),setTimeout(()=>{b()},r)}else e.value="Login failed after multiple attempts",o.value="Please try one of the options below",k.value=!0,n.value=!0,t.value=!1,I(),sessionStorage.removeItem("auth_callback_in_progress")}};return M(async()=>{try{if(g.getToken()){console.log("Token exists - setting absolute trust flags and redirecting"),localStorage.setItem("token_absolute_trust","true"),localStorage.setItem("token_trusted","true"),localStorage.setItem("token_verified","true"),localStorage.setItem("auth_callback_completed_time",Date.now().toString()),localStorage.setItem("skip_all_token_validation","true"),e.value="Already authenticated",o.value="Redirecting to dashboard...",t.value=!1,n.value=!1,window.location.href="/dashboard";return}if(localStorage.getItem(v)==="true"){const u=parseInt(localStorage.getItem("auth_processing_start_time")||"0");Date.now()-u>3e4&&localStorage.removeItem(v)}if(localStorage.setItem("auth_processing_start_time",Date.now().toString()),sessionStorage.getItem("auth_callback_processed")==="true"||sessionStorage.getItem("auth_callback_in_progress")==="true"||localStorage.getItem(v)==="true"){console.log("Callback already processed or in progress, skipping"),e.value="Login already in progress",o.value="Please wait or try again",n.value=!0,t.value=!1,h.value=!0,I();return}if(!new URLSearchParams(window.location.search).has("code")){e.value="Missing authorization code",o.value="Please try again",n.value=!0,t.value=!1;return}try{const u=parseInt(localStorage.getItem("auth_validation_start_time")||"0");Date.now()-u>3e4&&(console.log("Clearing possible stale auth locks"),f(p.SIGNIN),f(p.REFRESH),f(p.VALIDATION),sessionStorage.removeItem("casdoor_processed_code"),sessionStorage.removeItem("casdoor_auth_processed"))}catch(u){console.error("Error clearing auth locks:",u)}I(),await b()}catch(a){console.error("Error during callback setup:",a),e.value="An unexpected error occurred",o.value="Please try again",n.value=!0,t.value=!1}}),{message:e,subMessage:o,showDebug:k,debugInfo:S,showRetryButton:n,isLoading:t,handleManualLogin:async()=>{m.value||(h.value=!1,sessionStorage.removeItem("auth_callback_processed"),sessionStorage.removeItem("auth_callback_in_progress"),sessionStorage.removeItem("processed_auth_code"),sessionStorage.removeItem("casdoor_processed_code"),sessionStorage.removeItem("casdoor_auth_processed"),localStorage.removeItem(v),f(p.SIGNIN),f(p.REFRESH),c.value=0,await b())},handleDirectLogin:()=>{m.value||(sessionStorage.clear(),localStorage.removeItem("auth_callback_processed"),localStorage.removeItem("auth_callback_in_progress"),localStorage.removeItem("casdoor-token"),localStorage.removeItem("casdoor-refresh-token"),localStorage.removeItem("casdoor-user-info"),g.startLogin())},redirectToLogin:A}}}),B={class:"min-h-screen flex items-center justify-center bg-gray-50"},z={class:"max-w-md w-full p-6 bg-white rounded-lg shadow-md"},G={class:"text-center"},O={class:"flex justify-center mb-4"},V={class:"flex items-center justify-center"},F={class:"text-xl font-semibold text-gray-800 mb-2"},H={class:"text-gray-600"},j={key:0,class:"mt-4 p-4 bg-gray-100 rounded text-left text-xs overflow-auto max-h-60"},K={key:1,class:"mt-4 space-y-2"},W={class:"mt-2"},Y={class:"mt-4"};function J(s,e,o,k,S,n){const t=U("Icon");return _(),w("div",B,[l("div",z,[l("div",G,[l("div",O,[l("div",V,[s.isLoading?(_(),y(t,{key:0,icon:"line-md:loading-loop",class:"w-12 h-12 text-blue-600"})):s.message.includes("success")?(_(),y(t,{key:1,icon:"mdi:check-circle",class:"w-12 h-12 text-green-500"})):(_(),y(t,{key:2,icon:"mdi:alert-circle",class:"w-12 h-12 text-red-500"}))])]),l("h2",F,L(s.message),1),l("p",H,L(s.subMessage),1),s.showDebug?(_(),w("div",j,[l("pre",null,L(s.debugInfo),1)])):P("",!0),s.showRetryButton?(_(),w("div",K,[l("button",{onClick:e[0]||(e[0]=(...i)=>s.handleManualLogin&&s.handleManualLogin(...i)),class:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"}," Try Again "),l("div",W,[l("button",{onClick:e[1]||(e[1]=(...i)=>s.handleDirectLogin&&s.handleDirectLogin(...i)),class:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"}," Use Direct Login ")]),l("div",Y,[l("button",{onClick:e[2]||(e[2]=(...i)=>s.redirectToLogin&&s.redirectToLogin(...i)),class:"px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800"}," Return to Login Page ")])])):P("",!0)])])])}const se=R($,[["render",J]]);export{se as default};
